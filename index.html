<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FondeoEmprende2026 - Control Operativo</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --azul: #0a192f; --dorado: #d4af37; --verde: #004d40; --gris: #f8f9fa; }
        body { background: var(--gris); font-family: 'Segoe UI', sans-serif; }
        .navbar { background: var(--azul); border-bottom: 3px solid var(--dorado); padding: 10px 0; }
        .navbar-brand { cursor: pointer; display: flex; align-items: center; text-decoration: none; }
        .navbar-brand img { height: 50px; background: white; padding: 2px; border-radius: 5px; margin-right: 15px; }
        .card-custom { border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.08); background: white; margin-bottom: 20px; }
        .btn-3d { background: var(--verde); color: white; border: none; padding: 12px; border-bottom: 4px solid #002b24; font-weight: bold; border-radius: 12px; }
        .btn-3d:hover { background: #006b57; color: white; }
        .section-hidden { display: none !important; }
        .table-admin { font-size: 0.85rem; }
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.55); z-index: 9999;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: white; border-radius: 20px; padding: 30px;
            width: 90%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popIn 0.2s ease;
        }
        @keyframes popIn { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .partida-badge { display:inline-block; background:#e8f5e9; color:#2e7d32; border-radius:20px; padding:3px 10px; font-size:0.78rem; margin:2px; }
        .saldo-ok   { color: #004d40; }
        .saldo-warn { color: #e65100; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark shadow">
    <div class="container d-flex justify-content-between">
        <a class="navbar-brand" href="https://proyectoemprende2026.github.io/Principal/">
            <img src="https://raw.githubusercontent.com/proyectoemprende2026/Plataforma/main/LogoFondeoEmprende2026.jpg" alt="Logo">
            <span class="fw-bold text-white">FondeoEmprende2026</span>
        </a>
        <div>
            <button type="button" onclick="navegar('pantalla-login')" class="btn btn-outline-warning btn-sm me-2">YA TENGO PIN</button>
            <button type="button" onclick="accesoAdmin()" class="btn btn-sm btn-light">ADMIN</button>
        </div>
    </div>
</nav>

<div class="container mt-4 pb-5">

    <!-- REGISTRO -->
    <div id="pantalla-registro" class="row justify-content-center">
        <div class="col-md-6">
            <div class="card card-custom p-4">
                <h4 class="fw-bold text-center mb-4">Alta de Beneficiario</h4>
                <input type="text" id="reg-nombre" class="form-control mb-2" placeholder="Nombre completo">
                <input type="text" id="proy-nombre" class="form-control mb-2" placeholder="Nombre del proyecto">
                <label class="small fw-bold">Proyecto resumido</label>
                <input type="url" id="proy-link" class="form-control mb-2" placeholder="https://drive.google.com/... (PDF del proyecto)">
                <div class="input-group mb-3">
                    <span class="input-group-text">$</span>
                    <input type="number" id="reg-saldo" class="form-control" placeholder="Saldo inicial (ej. 13500000)" value="13500000">
                    <span class="input-group-text">MXN</span>
                </div>
                <div class="p-3 bg-light rounded mb-3 text-start">
                    <p class="small fw-bold mb-2">A√±adir partidas de presupuesto:</p>
                    <div class="input-group mb-2">
                        <input type="text" id="partida-input" class="form-control" placeholder="Ej: Infraestructura">
                        <button type="button" onclick="addPartida()" class="btn btn-dark">+</button>
                    </div>
                    <ul id="lista-partidas" class="small mb-0 list-unstyled"></ul>
                </div>
                <button type="button" onclick="crearCuenta()" class="btn btn-3d w-100">FINALIZAR Y GENERAR ACCESO</button>
            </div>
        </div>
    </div>

    <!-- √âXITO -->
    <div id="pantalla-exito" class="row justify-content-center section-hidden">
        <div class="col-md-5 text-center">
            <div class="card card-custom p-4 border-top border-4 border-warning">
                <h3 class="text-success fw-bold">¬°Acceso Correcto!</h3>
                <p>Tu PIN de acceso operativo es:</p>
                <h1 id="show-pin" class="display-2 fw-bold"></h1>
                <div id="qrcode" class="d-flex justify-content-center my-3"></div>
                <p class="small text-danger fw-bold">‚ö†Ô∏è Toma captura de pantalla ahora.</p>
                <button type="button" onclick="navegar('pantalla-login')" class="btn btn-dark w-100">CONTINUAR AL LOGIN</button>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="pantalla-login" class="row justify-content-center section-hidden">
        <div class="col-md-4">
            <div class="card card-custom p-4 text-center">
                <h5 class="fw-bold">Acceso con PIN</h5>
                <input type="text" id="login-pin" class="form-control form-control-lg text-center fw-bold my-4" maxlength="4" placeholder="0000">
                <button type="button" onclick="validarPin()" class="btn btn-3d w-100">ENTRAR AL DASHBOARD</button>
                <button type="button" onclick="navegar('pantalla-registro')" class="btn btn-link btn-sm mt-3 text-secondary text-decoration-none">Nuevo Beneficiario</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="pantalla-dashboard" class="section-hidden">
        <div class="row">
            <div class="col-md-5">
                <div class="card card-custom p-4 text-center shadow">
                    <h5 id="dash-user-name" class="fw-bold text-uppercase">--</h5>
                    <p id="dash-proy-name" class="small text-muted mb-3">--</p>
                    <div class="mb-1"><span class="badge bg-primary">DISPONIBLE</span></div>
                    <h2 id="dash-saldo" class="fw-bold display-6 mb-4 saldo-ok">$0.00</h2>
                    <div style="height: 220px;"><canvas id="mainChart"></canvas></div>
                    <div id="dash-resumen-partidas" class="mt-3 text-start"></div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card card-custom p-4 border-top border-4 border-success">
                    <h6 class="fw-bold mb-3">SUBIR COMPROBANTE FISCAL</h6>
                    <label class="small fw-bold">Partida</label>
                    <select id="dash-sel-partida" class="form-select mb-2"></select>
                    <label class="small fw-bold">Monto (MXN)</label>
                    <input type="number" id="dash-monto" class="form-control mb-2" placeholder="0.00">
                    <label class="small fw-bold">Link de Evidencia (Drive)</label>
                    <input type="url" id="dash-link" class="form-control mb-3" placeholder="https://drive.google.com/...">
                    <button type="button" onclick="subirGasto()" class="btn btn-3d w-100">ACTUALIZAR SALDO Y REGISTRAR</button>
                </div>
                <div class="card card-custom p-4">
                    <h6 class="fw-bold mb-3">BIT√ÅCORA DE GASTOS</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th>Partida</th><th>Monto</th><th>Fecha</th><th>Evidencia</th><th></th>
                                </tr>
                            </thead>
                            <tbody id="tabla-body" class="small"></tbody>
                        </table>
                    </div>
                    <hr>
                    <button type="button" onclick="location.reload()" class="btn btn-outline-danger w-100 fw-bold">CERRAR SESI√ìN SEGURA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN -->
    <div id="pantalla-admin" class="section-hidden">
        <div class="card card-custom p-4 shadow-lg">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Auditor√≠a Maestra</h5>
                <div>
                    <button type="button" onclick="abrirModalPassword()" class="btn btn-sm btn-outline-warning me-2">üîë Cambiar Contrase√±a</button>
                    <button type="button" onclick="exportarCSV()" class="btn btn-sm btn-outline-success me-2">‚¨á Exportar CSV</button>
                    <button type="button" onclick="navegar('pantalla-registro')" class="btn btn-sm btn-secondary">Cerrar</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-admin align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Beneficiario</th><th>PIN</th><th>Proyecto</th>
                            <th>Saldo Inicial</th><th>Ejercido</th><th>Disponible</th>
                            <th>Partidas</th><th>Estado</th><th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- MODAL: ELIMINAR GASTO -->
<div id="modal-eliminar-gasto" class="modal-overlay" onclick="clickFueraModal(event,'modal-eliminar-gasto')">
    <div class="modal-box text-center">
        <div style="font-size:2.5rem;">üóëÔ∏è</div>
        <h5 class="fw-bold mt-2">¬øEliminar este registro?</h5>
        <p class="small text-muted" id="modal-gasto-detalle">---</p>
        <p class="small text-danger fw-bold">El saldo se recalcular√° autom√°ticamente.</p>
        <div class="d-flex gap-2 mt-3">
            <button type="button" onclick="cerrarModal('modal-eliminar-gasto')" class="btn btn-outline-secondary w-50">Cancelar</button>
            <button type="button" id="btn-confirmar-eliminar-gasto" class="btn btn-danger w-50 fw-bold">Eliminar</button>
        </div>
    </div>
</div>

<!-- MODAL: ELIMINAR USUARIO -->
<div id="modal-eliminar" class="modal-overlay" onclick="clickFueraModal(event,'modal-eliminar')">
    <div class="modal-box text-center">
        <div style="font-size:3rem;">üóëÔ∏è</div>
        <h5 class="fw-bold mt-2">¬øEliminar este usuario?</h5>
        <p class="small text-muted" id="modal-eliminar-nombre">---</p>
        <p class="small text-danger fw-bold">Esta acci√≥n es permanente e irreversible.</p>
        <div class="d-flex gap-2 mt-3">
            <button type="button" onclick="cerrarModal('modal-eliminar')" class="btn btn-outline-secondary w-50">Cancelar</button>
            <button type="button" id="btn-confirmar-eliminar" class="btn btn-danger w-50 fw-bold">Eliminar</button>
        </div>
    </div>
</div>

<!-- MODAL: CAMBIAR PASSWORD -->
<div id="modal-password" class="modal-overlay" onclick="clickFueraModal(event,'modal-password')">
    <div class="modal-box">
        <h5 class="fw-bold mb-3 text-center">üîë Cambiar Contrase√±a Admin</h5>
        <label class="small fw-bold">Contrase√±a actual</label>
        <input type="password" id="pw-actual" class="form-control mb-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <label class="small fw-bold">Nueva contrase√±a</label>
        <input type="password" id="pw-nueva" class="form-control mb-2" placeholder="M√≠nimo 8 caracteres">
        <label class="small fw-bold">Confirmar nueva contrase√±a</label>
        <input type="password" id="pw-confirmar" class="form-control mb-3" placeholder="Repetir nueva contrase√±a">
        <div id="pw-error" class="alert alert-danger py-2 small section-hidden"></div>
        <div class="d-flex gap-2">
            <button type="button" onclick="cerrarModal('modal-password')" class="btn btn-outline-secondary w-50">Cancelar</button>
            <button type="button" onclick="cambiarPassword()" class="btn btn-warning w-50 fw-bold">Guardar</button>
        </div>
    </div>
</div>

<!-- MODAL: DETALLE PARTIDAS -->
<div id="modal-detalle" class="modal-overlay" onclick="clickFueraModal(event,'modal-detalle')">
    <div class="modal-box">
        <h5 class="fw-bold mb-3" id="modal-detalle-titulo">Detalle por Partida</h5>
        <div id="modal-detalle-body"></div>
        <button type="button" onclick="cerrarModal('modal-detalle')" class="btn btn-dark w-100 mt-3">Cerrar</button>
    </div>
</div>

<script>
// FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyA1T0OaksBYi9-E9MlIUJvKnoQ2e6uOCx8",
    authDomain: "proyectoemprende26.firebaseapp.com",
    projectId: "proyectoemprende26",
    storageBucket: "proyectoemprende26.firebasestorage.app",
    messagingSenderId: "57446946914",
    appId: "1:57446946914:web:cf9ff716e038b866d8193b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ESTADO GLOBAL
let v_partidas     = [];
let v_user         = null;
let v_chart        = null;
let v_adminPwd     = null;
let v_pinAEliminar = null;
let v_allUsers     = [];

// NAVEGACI√ìN
function navegar(id) {
    ['pantalla-registro','pantalla-login','pantalla-dashboard','pantalla-admin','pantalla-exito']
        .forEach(function(s) { var el = document.getElementById(s); if(el) el.classList.add('section-hidden'); });
    document.getElementById(id).classList.remove('section-hidden');
}

// MODALES
function abrirModal(id)  { document.getElementById(id).classList.add('active'); }
function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
function clickFueraModal(e, id) { if(e.target === document.getElementById(id)) cerrarModal(id); }

// PARTIDAS
function addPartida() {
    var input = document.getElementById('partida-input');
    var valor = input.value.trim();
    if(!valor) return;
    var idx = v_partidas.length;
    v_partidas.push(valor);
    var li = document.createElement('li');
    li.id = 'partida-li-' + idx;
    li.className = 'd-flex align-items-center justify-content-between mb-1';
    li.innerHTML = '<span><span class="text-success">‚úî</span> ' + valor + '</span>'
        + '<button type="button" onclick="eliminarPartida(' + idx + ')" class="btn btn-sm btn-outline-danger py-0 px-1">‚úï</button>';
    document.getElementById('lista-partidas').appendChild(li);
    input.value = '';
}

function eliminarPartida(idx) {
    v_partidas[idx] = null;
    var li = document.getElementById('partida-li-' + idx);
    if(li) li.remove();
}

// CREAR CUENTA
async function crearCuenta() {
    var nom      = document.getElementById('reg-nombre').value.trim();
    var proy     = document.getElementById('proy-nombre').value.trim();
    var proyLink = document.getElementById('proy-link').value.trim();
    var saldo    = parseFloat(document.getElementById('reg-saldo').value) || 13500000;
    var partidasLimpias = v_partidas.filter(function(p){ return p !== null; });
    if(!nom || partidasLimpias.length === 0)
        return alert("Error: Debe ingresar nombre y al menos una partida.");
    var pin = Math.floor(1000 + Math.random() * 9000).toString();
    await db.collection("usuarios").doc(pin).set({
        nombre: nom, proyecto: proy, proyectoLink: proyLink,
        pin: pin, partidas: partidasLimpias, gastos: [],
        saldoInicial: saldo, bloqueado: false
    });
    document.getElementById('show-pin').innerText = pin;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: pin, width: 140, height: 140 });
    v_partidas = [];
    document.getElementById('lista-partidas').innerHTML = '';
    document.getElementById('reg-nombre').value  = '';
    document.getElementById('proy-nombre').value = '';
    document.getElementById('proy-link').value   = '';
    document.getElementById('reg-saldo').value   = '13500000';
    navegar('pantalla-exito');
}

// LOGIN
async function validarPin() {
    var pinInput = document.getElementById('login-pin').value;
    var doc = await db.collection("usuarios").doc(pinInput).get();
    if(doc.exists) {
        v_user = doc.data();
        if(v_user.bloqueado) return alert("Acceso bloqueado por el administrador.");
        document.getElementById('dash-user-name').innerText = v_user.nombre;
        document.getElementById('dash-proy-name').innerText = v_user.proyecto;
        var sel = document.getElementById('dash-sel-partida');
        sel.innerHTML = '';
        v_user.partidas.forEach(function(p){ sel.add(new Option(p, p)); });
        actualizarFinanzas();
        navegar('pantalla-dashboard');
    } else {
        alert("PIN no registrado.");
    }
}

// SUBIR GASTO
async function subirGasto() {
    var monto   = parseFloat(document.getElementById('dash-monto').value);
    var partida = document.getElementById('dash-sel-partida').value;
    var link    = document.getElementById('dash-link').value.trim();
    if(!monto || !link) return alert("Por favor complete monto y link de Drive.");
    var fecha = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'2-digit', year:'numeric' });
    v_user.gastos.push({ partida: partida, monto: monto, link: link, fecha: fecha });
    await db.collection("usuarios").doc(v_user.pin).update({ gastos: v_user.gastos });
    document.getElementById('dash-monto').value = '';
    document.getElementById('dash-link').value  = '';
    actualizarFinanzas();
    alert("Saldo actualizado correctamente.");
}

// ELIMINAR GASTO
function pedirEliminarGasto(idx) {
    var g = v_user.gastos[idx];
    if(!g) return;
    document.getElementById('modal-gasto-detalle').innerText =
        g.partida + ' ‚Äî $' + g.monto.toLocaleString('es-MX') + ' ‚Äî ' + (g.fecha || '');
    document.getElementById('btn-confirmar-eliminar-gasto').onclick = async function() {
        v_user.gastos.splice(idx, 1);
        await db.collection("usuarios").doc(v_user.pin).update({ gastos: v_user.gastos });
        cerrarModal('modal-eliminar-gasto');
        actualizarFinanzas();
    };
    abrirModal('modal-eliminar-gasto');
}

// MOTOR DE FINANZAS
function actualizarFinanzas() {
    var saldoInicial = v_user.saldoInicial || 13500000;
    var totalGastado = v_user.gastos.reduce(function(acc, obj){ return acc + obj.monto; }, 0);
    var saldoActual  = saldoInicial - totalGastado;
    var pct          = totalGastado / saldoInicial;

    var el = document.getElementById('dash-saldo');
    el.innerText = '$' + saldoActual.toLocaleString('es-MX', { minimumFractionDigits: 2 });
    el.className = 'fw-bold display-6 mb-4 ' + (pct >= 0.8 ? 'saldo-warn' : 'saldo-ok');

    // Tabla bit√°cora
    var body = document.getElementById('tabla-body');
    body.innerHTML = '';
    v_user.gastos.slice().reverse().forEach(function(g, iRev) {
        var iReal = v_user.gastos.length - 1 - iRev;
        body.innerHTML += '<tr>'
            + '<td>' + g.partida + '</td>'
            + '<td class="fw-bold">$' + g.monto.toLocaleString('es-MX') + '</td>'
            + '<td class="text-muted">' + (g.fecha || '‚Äî') + '</td>'
            + '<td><a href="' + g.link + '" target="_blank" class="btn btn-sm btn-outline-primary py-0">üìÇ</a></td>'
            + '<td><button type="button" onclick="pedirEliminarGasto(' + iReal + ')" class="btn btn-sm btn-outline-danger py-0" title="Eliminar">üóëÔ∏è</button></td>'
            + '</tr>';
    });

    // Resumen por partida
    var resumenEl = document.getElementById('dash-resumen-partidas');
    var resumen   = {};
    v_user.gastos.forEach(function(g){ resumen[g.partida] = (resumen[g.partida] || 0) + g.monto; });
    if(Object.keys(resumen).length) {
        var html = '<p class="small fw-bold text-muted mb-1">Ejercido por partida:</p>';
        Object.entries(resumen).forEach(function(entry) {
            html += '<div class="d-flex justify-content-between small mb-1"><span>' + entry[0] + '</span>'
                  + '<span class="fw-bold">$' + entry[1].toLocaleString('es-MX') + '</span></div>';
        });
        resumenEl.innerHTML = html;
    } else {
        resumenEl.innerHTML = '';
    }

    // Gr√°fica
    var ctx = document.getElementById('mainChart').getContext('2d');
    if(v_chart) v_chart.destroy();
    v_chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Disponible','Ejercido'],
            datasets: [{ data: [saldoActual, totalGastado], backgroundColor: ['#0a192f','#d4af37'], borderWidth: 0 }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

// ADMIN: ACCESO
async function accesoAdmin() {
    var cfgDoc = await db.collection("config").doc("admin").get();
    v_adminPwd = cfgDoc.exists ? cfgDoc.data().password : "Admin100583";
    var input = prompt("Clave Maestra:");
    if(input === v_adminPwd) {
        navegar('pantalla-admin');
        renderAdmin();
    } else {
        alert("Clave incorrecta.");
    }
}

// ADMIN: RENDER TABLA
async function renderAdmin() {
    var snap = await db.collection("usuarios").get();
    var tbody = document.getElementById('admin-table-body');
    tbody.innerHTML = '';
    v_allUsers = [];
    snap.forEach(function(doc) {
        var u = doc.data();
        v_allUsers.push(u);
        var saldoInicial = u.saldoInicial || 13500000;
        var ejercido     = (u.gastos || []).reduce(function(a,g){ return a + g.monto; }, 0);
        var disponible   = saldoInicial - ejercido;
        var partidasBadges = (u.partidas || []).map(function(p){
            return '<span class="partida-badge">' + p + '</span>';
        }).join('');
        var linkPDF = u.proyectoLink
            ? ' <a href="' + u.proyectoLink + '" target="_blank" class="btn btn-sm btn-outline-secondary py-0 ms-1" title="Ver PDF">üìÑ</a>'
            : '';
        tbody.innerHTML += '<tr class="align-middle">'
            + '<td><strong>' + u.nombre + '</strong></td>'
            + '<td><code class="fs-6">' + u.pin + '</code></td>'
            + '<td>' + u.proyecto + linkPDF + '</td>'
            + '<td class="text-end">$' + saldoInicial.toLocaleString('es-MX') + '</td>'
            + '<td class="text-end fw-bold text-warning">$' + ejercido.toLocaleString('es-MX') + '</td>'
            + '<td class="text-end fw-bold ' + (disponible < saldoInicial * 0.2 ? 'text-danger' : 'text-success') + '">$' + disponible.toLocaleString('es-MX') + '</td>'
            + '<td>' + partidasBadges
            +   '<button type="button" onclick="verDetallePartidas(\'' + u.pin + '\')" class="btn btn-sm btn-outline-dark mt-1 py-0">üìä Detalle</button></td>'
            + '<td><span class="badge ' + (u.bloqueado ? 'bg-danger' : 'bg-success') + '">' + (u.bloqueado ? 'Bloqueado' : 'Activo') + '</span></td>'
            + '<td><div class="d-flex gap-1">'
            +   '<button type="button" onclick="toggleU(\'' + u.pin + '\',' + u.bloqueado + ')" class="btn btn-sm btn-dark">' + (u.bloqueado ? '‚úÖ' : 'üîí') + '</button>'
            +   '<button type="button" onclick="pedirEliminar(\'' + u.pin + '\',\'' + u.nombre.replace(/'/g,"\\'") + '\',\'' + u.proyecto.replace(/'/g,"\\'") + '\')" class="btn btn-sm btn-danger">üóëÔ∏è</button>'
            + '</div></td></tr>';
    });
}

// ADMIN: BLOQUEAR/DESBLOQUEAR
async function toggleU(p, s) {
    await db.collection("usuarios").doc(p).update({ bloqueado: !s });
    renderAdmin();
}

// ADMIN: ELIMINAR USUARIO
function pedirEliminar(pin, nombre, proyecto) {
    v_pinAEliminar = pin;
    document.getElementById('modal-eliminar-nombre').innerText = nombre + ' ‚Äî ' + proyecto;
    document.getElementById('btn-confirmar-eliminar').onclick = async function() {
        await db.collection("usuarios").doc(v_pinAEliminar).delete();
        cerrarModal('modal-eliminar');
        v_pinAEliminar = null;
        renderAdmin();
    };
    abrirModal('modal-eliminar');
}

// ADMIN: DETALLE PARTIDAS
function verDetallePartidas(pin) {
    var u = v_allUsers.find(function(x){ return x.pin === pin; });
    if(!u) return;
    var saldoInicial = u.saldoInicial || 13500000;
    var resumen = {};
    (u.partidas || []).forEach(function(p){ resumen[p] = 0; });
    (u.gastos   || []).forEach(function(g){ resumen[g.partida] = (resumen[g.partida] || 0) + g.monto; });
    document.getElementById('modal-detalle-titulo').innerText = 'üìä ' + u.nombre + ' ‚Äî ' + u.proyecto;
    var html = '<p class="small text-muted mb-2">Saldo Inicial: <strong>$' + saldoInicial.toLocaleString('es-MX') + '</strong></p>';
    Object.entries(resumen).forEach(function(entry) {
        var pct = saldoInicial > 0 ? Math.min(100, (entry[1] / saldoInicial) * 100) : 0;
        html += '<div class="mb-2"><div class="d-flex justify-content-between small"><span>' + entry[0] + '</span>'
              + '<span class="fw-bold">$' + entry[1].toLocaleString('es-MX') + '</span></div>'
              + '<div class="progress" style="height:6px"><div class="progress-bar bg-warning" style="width:' + pct + '%"></div></div></div>';
    });
    var totalEjercido = Object.values(resumen).reduce(function(a,b){ return a+b; }, 0);
    html += '<hr><div class="d-flex justify-content-between small fw-bold"><span>Total ejercido</span><span>$' + totalEjercido.toLocaleString('es-MX') + '</span></div>';
    document.getElementById('modal-detalle-body').innerHTML = html;
    abrirModal('modal-detalle');
}

// ADMIN: EXPORTAR CSV
function exportarCSV() {
    if(!v_allUsers.length) return alert("No hay datos cargados.");
    var csv = "Beneficiario,PIN,Proyecto,Saldo Inicial,Total Ejercido,Disponible,Partida,Monto,Fecha,Link\n";
    v_allUsers.forEach(function(u) {
        var saldoInicial = u.saldoInicial || 13500000;
        var ejercido     = (u.gastos||[]).reduce(function(a,g){ return a+g.monto; }, 0);
        var disponible   = saldoInicial - ejercido;
        if(!(u.gastos||[]).length) {
            csv += '"' + u.nombre + '","' + u.pin + '","' + u.proyecto + '",' + saldoInicial + ',' + ejercido + ',' + disponible + ',"‚Äî","‚Äî","‚Äî","‚Äî"\n';
        } else {
            u.gastos.forEach(function(g) {
                csv += '"' + u.nombre + '","' + u.pin + '","' + u.proyecto + '",' + saldoInicial + ',' + ejercido + ',' + disponible + ',"' + g.partida + '",' + g.monto + ',"' + (g.fecha||'') + '","' + g.link + '"\n';
            });
        }
    });
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url;
    a.download = 'FondeoEmprende_Auditoria_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// ADMIN: CAMBIAR PASSWORD
function abrirModalPassword() {
    document.getElementById('pw-actual').value    = '';
    document.getElementById('pw-nueva').value     = '';
    document.getElementById('pw-confirmar').value = '';
    document.getElementById('pw-error').classList.add('section-hidden');
    abrirModal('modal-password');
}

async function cambiarPassword() {
    var actual    = document.getElementById('pw-actual').value;
    var nueva     = document.getElementById('pw-nueva').value;
    var confirmar = document.getElementById('pw-confirmar').value;
    var errEl     = document.getElementById('pw-error');
    function mostrarError(msg) { errEl.innerText = msg; errEl.classList.remove('section-hidden'); }
    if(actual !== v_adminPwd)  return mostrarError("La contrase√±a actual no es correcta.");
    if(nueva.length < 8)       return mostrarError("La nueva contrase√±a debe tener m√≠nimo 8 caracteres.");
    if(nueva !== confirmar)    return mostrarError("Las contrase√±as nuevas no coinciden.");
    await db.collection("config").doc("admin").set({ password: nueva });
    v_adminPwd = nueva;
    cerrarModal('modal-password');
    alert("‚úÖ Contrase√±a actualizada correctamente.");
}
</script>
</body>
</html>
